import axios from "axios";
import {
    Connection,
    PublicKey,
    Keypair,
    Transaction,
    sendAndConfirmTransaction
} from "@solana/web3.js";
import {
    createCreateMetadataAccountV3Instruction
} from "@metaplex-foundation/mpl-token-metadata";

const PINATA_JWT = "Bearer YOUR_PINATA_JWT_TOKEN";  // Ø§Ø³ØªØ¨Ø¯Ù„Ù‡Ø§ Ø¨Ù€ API Key Ù…Ù† Pinata
const SOLANA_RPC_URL = "https://api.mainnet-beta.solana.com";  // Ø§Ø³ØªØ®Ø¯Ù… "https://api.testnet.solana.com" Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±

let uploadedImageUrl = "";  // Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡ Ø¨Ø¹Ø¯ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©

// ğŸ”¹ Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„ØªÙˆÙƒÙ† Ø¥Ù„Ù‰ IPFS ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
async function uploadToIPFS() {
    const fileInput = document.getElementById("tokenImage");
    const file = fileInput.files[0];

    if (!file) {
        alert("âŒ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹.");
        return;
    }

    document.getElementById("uploadStatus").innerText = "â³ Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ IPFS...";

    const formData = new FormData();
    formData.append("file", file);

    try {
        const response = await axios.post("https://api.pinata.cloud/pinning/pinFileToIPFS", formData, {
            headers: {
                "Authorization": PINATA_JWT,
                "Content-Type": "multipart/form-data"
            }
        });

        uploadedImageUrl = `https://ipfs.io/ipfs/${response.data.IpfsHash}`;
        console.log("âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­:", uploadedImageUrl);

        document.getElementById("tokenImagePreview").src = uploadedImageUrl;
        document.getElementById("tokenImagePreview").style.display = "block";

        document.getElementById("uploadStatus").innerText = "âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©!";
    } catch (error) {
        console.error("âŒ ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©:", error);
        document.getElementById("uploadStatus").innerText = "âŒ ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©!";
    }
}

// ğŸ”¹ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Metadata ÙˆØ±ÙØ¹Ù‡ Ø¥Ù„Ù‰ IPFS ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
async function generateMetadata(tokenName, tokenSymbol) {
    if (!uploadedImageUrl) {
        alert("âŒ ÙŠØ±Ø¬Ù‰ Ø±ÙØ¹ ØµÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹.");
        return;
    }

    const metadata = {
        name: tokenName,
        symbol: tokenSymbol,
        description: `This is the official metadata for ${tokenName}.`,
        image: uploadedImageUrl,
        external_url: "https://yourwebsite.com"
    };

    const formData = new FormData();
    const metadataBlob = new Blob([JSON.stringify(metadata)], { type: "application/json" });
    formData.append("file", metadataBlob, "metadata.json");

    try {
        const response = await axios.post("https://api.pinata.cloud/pinning/pinFileToIPFS", formData, {
            headers: {
                "Authorization": PINATA_JWT,
                "Content-Type": "multipart/form-data"
            }
        });

        const metadataUri = `https://ipfs.io/ipfs/${response.data.IpfsHash}`;
        console.log("âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØµÙÙŠØ©:", metadataUri);

        return metadataUri;
    } catch (error) {
        console.error("âŒ ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØµÙÙŠØ©:", error);
        return null;
    }
}

// ğŸ”¹ ØªØ³Ø¬ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙˆÙƒÙ† ÙÙŠ Metaplex ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
async function registerTokenMetadata(mintAddress, metadataUri, ownerPrivateKey) {
    const connection = new Connection(SOLANA_RPC_URL);
    const owner = Keypair.fromSecretKey(Uint8Array.from(ownerPrivateKey));

    const metadataProgramId = new PublicKey("metaqbxxUerdq28cj1RbAWkYQm3ybzjb6a8bt518x1s");
    const mint = new PublicKey(mintAddress);

    const [metadataAccount] = await PublicKey.findProgramAddress(
        [
            Buffer.from("metadata"),
            metadataProgramId.toBuffer(),
            mint.toBuffer(),
        ],
        metadataProgramId
    );

    const transaction = new Transaction().add(
        createCreateMetadataAccountV3Instruction(
            {
                metadata: metadataAccount,
                mint,
                mintAuthority: owner.publicKey,
                payer: owner.publicKey,
                updateAuthority: owner.publicKey,
            },
            {
                createMetadataAccountArgsV3: {
                    data: {
                        name: "AutoGeneratedToken",
                        symbol: "AUTO",
                        uri: metadataUri,
                        sellerFeeBasisPoints: 0,
                        creators: null,
                        collection: null,
                        uses: null
                    },
                    isMutable: true
                }
            }
        )
    );

    await sendAndConfirmTransaction(connection, transaction, [owner]);
    console.log("âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙˆÙƒÙ† Ø¹Ù„Ù‰ Metaplex Ø¨Ù†Ø¬Ø§Ø­!");
}

// ğŸ”¹ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙˆÙƒÙ† ÙˆØ±Ø¨Ø·Ù‡ Ø¨Ù€ Metadata ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
async function createToken() {
    const tokenName = document.getElementById("tokenName").value;
    const tokenSymbol = document.getElementById("tokenSymbol").value;

    if (!tokenName || !tokenSymbol) {
        alert("âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„ØªÙˆÙƒÙ† ÙˆØ±Ù…Ø²Ù‡!");
        return;
    }

    document.getElementById("uploadStatus").innerText = "ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙˆÙƒÙ†...";
    
    // 1ï¸âƒ£ Ø±ÙØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙˆÙƒÙ† Ø¥Ù„Ù‰ IPFS
    const metadataUri = await generateMetadata(tokenName, tokenSymbol);
    if (!metadataUri) return;

    // 2ï¸âƒ£ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙˆÙƒÙ† (ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù„Ø¯ÙŠÙƒ ÙˆØ¸ÙŠÙØ© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙˆÙƒÙ† ÙˆØ¥Ø±Ø¬Ø§Ø¹ Mint Address)
    const mintAddress = "YOUR_MINT_ADDRESS";  // Ø§Ø³ØªØ¨Ø¯Ù„Ù‡Ø§ Ø¨Ù…Ù†Ø·Ù‚ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙˆÙƒÙ†

    // 3ï¸âƒ£ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù„Ù‰ Metaplex
    await registerTokenMetadata(mintAddress, metadataUri, "YOUR_PRIVATE_KEY");

    document.getElementById("uploadStatus").innerText = "âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙˆÙƒÙ† Ø¨Ù†Ø¬Ø§Ø­!";
}

// ğŸ› ï¸ Ø±Ø¨Ø· Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø¨Ù€ `window` Ø­ØªÙ‰ ØªØ¹Ù…Ù„ Ø¹Ù†Ø¯ Ø§Ø³ØªØ¯Ø¹Ø§Ø¦Ù‡Ø§ Ù…Ù† HTML
window.uploadToIPFS = uploadToIPFS;
window.createToken = createToken;
