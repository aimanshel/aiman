const { Connection, PublicKey, Keypair, Transaction, sendAndConfirmTransaction } = solanaWeb3;
const { Token, TOKEN_PROGRAM_ID } = splToken;

let connection = new Connection("https://api.mainnet-beta.solana.com", "confirmed");
let wallet = null;

// تحديث الشبكة بناءً على اختيار المستخدم
function updateNetwork() {
    let selectedNetwork = document.getElementById("networkSelector").value;
    connection = new Connection(
        selectedNetwork === "mainnet-beta"
            ? "https://api.mainnet-beta.solana.com"
            : "https://api.testnet.solana.com",
        "confirmed"
    );
    document.getElementById("status").innerText = `✅ Switched to ${selectedNetwork}`;
}

// توصيل المحفظة
async function connectWallet() {
    try {
        if (!window.solana || !window.solana.isPhantom) {
            alert("🚨 يرجى تثبيت محفظة Phantom Wallet!");
            return;
        }
        wallet = window.solana;
        const response = await wallet.connect();
        document.getElementById("walletStatus").innerText = `✅ متصل: ${response.publicKey.toBase58()}`;
    } catch (error) {
        console.error(error);
        document.getElementById("walletStatus").innerText = "❌ فشل في الاتصال بالمحفظة.";
    }
}

// إنشاء التوكن فعليًا
async function createToken() {
    if (!wallet || !wallet.publicKey) {
        alert("❌ يرجى توصيل المحفظة أولاً.");
        return;
    }

    try {
        document.getElementById("loading").style.display = "block";
        document.getElementById("status").innerText = "🔄 جاري إنشاء التوكن...";

        // استخراج القيم من المدخلات
        const tokenName = document.getElementById("tokenName").value.trim();
        const tokenSymbol = document.getElementById("tokenSymbol").value.trim();
        const decimals = parseInt(document.getElementById("decimals").value);
        const supply = parseInt(document.getElementById("supply").value);

        if (!tokenName || !tokenSymbol || !supply) {
            alert("❌ يرجى ملء جميع الحقول!");
            document.getElementById("loading").style.display = "none";
            return;
        }

        // توليد حساب جديد للمينت (Mint Account)
        const mintAccount = Keypair.generate();

        // إنشاء التوكن
        const token = await Token.createMint(
            connection,
            wallet,
            wallet.publicKey, // Authority
            null, // Freeze authority
            decimals,
            mintAccount,
            TOKEN_PROGRAM_ID
        );

        // إنشاء حساب للحيازة
        const tokenAccount = await token.getOrCreateAssociatedAccountInfo(wallet.publicKey);

        // سك التوكنات (Mint Tokens)
        await token.mintTo(
            tokenAccount.address,
            wallet.publicKey,
            [],
            supply * Math.pow(10, decimals) // تحويل إلى وحدات أصغر
        );

        document.getElementById("loading").style.display = "none";
        document.getElementById("status").innerHTML = `✅ تم إنشاء التوكن بنجاح!<br>Mint Address: <b>${mintAccount.publicKey.toBase58()}</b>`;
    } catch (error) {
        console.error(error);
        document.getElementById("loading").style.display = "none";
        document.getElementById("status").innerText = "❌ فشل في إنشاء التوكن!";
    }
}
